name: Update Data Lock

on:
  schedule:
    - cron: "0 8 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Use Node 24
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Sync submodules
        run: npm run data:sync

      - name: Update sdk versions from docs
        run: npm run data:versions:strict

      - name: Verify sdk versions are synced
        run: npm run data:verify-versions:strict

      - name: Update lock manifest
        run: npm run data:lock

      - name: Detect data/source changes
        id: detect_changes
        shell: bash
        run: |
          set -euo pipefail
          changed_files="$(git diff --name-only)"
          echo "changed_files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$changed_files" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          data_changed="false"
          if echo "$changed_files" | grep -Eq '^(data/metadata/data-manifest\.json|data/metadata/dynamsoft_sdks\.json|\.gitmodules|data/samples/|data/documentation/)'; then
            data_changed="true"
          fi
          echo "data_changed=$data_changed" >> "$GITHUB_OUTPUT"

          echo "[data-refresh] changed_files:"
          if [[ -n "$changed_files" ]]; then
            echo "$changed_files"
          else
            echo "(none)"
          fi
          echo "[data-refresh] data_changed=$data_changed"

      - name: Bump patch version for data refresh
        id: bump_version
        if: steps.detect_changes.outputs.data_changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          old_version="$(node -p "require('./package.json').version")"
          npm version patch --no-git-tag-version
          new_version="$(node -p "require('./package.json').version")"
          echo "old_version=$old_version" >> "$GITHUB_OUTPUT"
          echo "new_version=$new_version" >> "$GITHUB_OUTPUT"
          echo "[data-refresh] version bump $old_version -> $new_version"

      - name: Verify lock manifest
        run: npm run data:verify-lock

      - name: Run tests
        run: npm test

      - name: Build PR metadata
        id: pr_meta
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ steps.detect_changes.outputs.data_changed }}" == "true" ]]; then
            title="[data-release] chore: refresh data lock + patch bump v${{ steps.bump_version.outputs.new_version }}"
            commit_message="chore(data): refresh lock and bump version to v${{ steps.bump_version.outputs.new_version }}"
            labels="data-refresh,release:patch-data"
            body=$(cat <<'EOF'
          Automated daily refresh:
          - Fast-forward data submodules to configured branches
          - Update `data/metadata/data-manifest.json`
          - Auto-bump patch version for data refresh

          Version:
          - Previous: v${{ steps.bump_version.outputs.old_version }}
          - Current: v${{ steps.bump_version.outputs.new_version }}
          EOF
            )
          else
            title="[data-refresh] chore: update data lock manifest"
            commit_message="chore(data): update data lock manifest"
            labels="data-refresh"
            body=$(cat <<'EOF'
          Automated daily refresh:
          - Fast-forward data submodules to configured branches
          - Update `data/metadata/data-manifest.json`

          Note:
          - No patch bump was applied because no data/source changes were detected.
          EOF
            )
          fi

          echo "title=$title" >> "$GITHUB_OUTPUT"
          echo "commit_message=$commit_message" >> "$GITHUB_OUTPUT"
          echo "labels=$labels" >> "$GITHUB_OUTPUT"
          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          echo "$body" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "[data-refresh] pr_title=$title"
          echo "[data-refresh] pr_labels=$labels"
          echo "[data-refresh] commit_message=$commit_message"

      - name: Workflow summary
        shell: bash
        run: |
          {
            echo "## Data Refresh Summary"
            echo ""
            echo "- data_changed: \`${{ steps.detect_changes.outputs.data_changed }}\`"
            if [[ "${{ steps.detect_changes.outputs.data_changed }}" == "true" ]]; then
              echo "- version: \`v${{ steps.bump_version.outputs.old_version }} -> v${{ steps.bump_version.outputs.new_version }}\`"
            else
              echo "- version: \`unchanged\`"
            fi
            echo "- pr_title: \`${{ steps.pr_meta.outputs.title }}\`"
            echo "- pr_labels: \`${{ steps.pr_meta.outputs.labels }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Ensure automation labels exist
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [
              { name: "data-refresh", color: "1D76DB", description: "Automated data refresh PR" },
              { name: "release:patch-data", color: "0E8A16", description: "Patch release from data refresh" }
            ];
            const { owner, repo } = context.repo;
            for (const label of labels) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name: label.name });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({ owner, repo, ...label });
                } else {
                  throw error;
                }
              }
            }

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: ${{ steps.pr_meta.outputs.commit_message }}
          title: ${{ steps.pr_meta.outputs.title }}
          body: ${{ steps.pr_meta.outputs.body }}
          labels: ${{ steps.pr_meta.outputs.labels }}
          branch: "chore/daily-data-refresh"
          delete-branch: true
